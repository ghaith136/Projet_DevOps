pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    environment {
        APP_NAME = "meteo-app-pr"
        DOCKER_IMAGE = "meteo-app-pr-${BUILD_NUMBER}"
        CONTAINER_NAME = "meteo-app-pr-${BUILD_NUMBER}"
        HOST_PORT = "3000"  // Port 3000
    }

    stages {
        stage('PR Info') {
            steps {
                echo "PIPELINE 1: Build & Smoke sur PR"
                bat "echo Build #${BUILD_NUMBER}"
            }
        }
        
        stage('Checkout') {
            steps {
                echo "Checkout code"
                checkout scm
                bat 'dir'
            }
        }

        stage('Setup') {
            steps {
                bat 'npm install'
                bat 'echo Dependances installees'
            }
        }

        stage('Build') {
            steps {
                bat 'npm run build'
                bat 'echo Build termine'
            }
        }

        stage('Docker Build') {
            steps {
                bat """
                docker build -t ${DOCKER_IMAGE} .
                echo Image construite: ${DOCKER_IMAGE}
                """
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    bat """
                    docker stop ${CONTAINER_NAME} 2>nul || echo OK
                    docker rm ${CONTAINER_NAME} 2>nul || echo OK
                    
                    docker run -d -p ${HOST_PORT}:3000 --name ${CONTAINER_NAME} ${DOCKER_IMAGE}
                    timeout /t 10 /nobreak
                    
                    curl -f http://localhost:${HOST_PORT} && (
                        echo Test racine PASS
                    ) || (
                        echo Test racine FAIL
                        docker logs ${CONTAINER_NAME}
                        exit 1
                    )
                    
                    curl -f http://localhost:${HOST_PORT}/health && (
                        echo Test sante PASS
                    ) || (
                        echo Test sante FAIL
                        exit 1
                    )
                    
                    echo Smoke test reussi
                    """
                }
            }
        }

        stage('Report') {
            steps {
                bat """
                echo # Rapport PR > pr_report.md
                echo Build: ${BUILD_NUMBER} >> pr_report.md
                echo Statut: PASS >> pr_report.md
                echo Date: %DATE% %TIME% >> pr_report.md
                """
                archiveArtifacts artifacts: 'pr_report.md', fingerprint: true
            }
        }

        stage('Cleanup') {
            steps {
                bat """
                docker stop ${CONTAINER_NAME} 2>nul || echo OK
                docker rm ${CONTAINER_NAME} 2>nul || echo OK
                """
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        
        success {
            echo "PR READY FOR MERGE"
        }
        
        failure {
            echo "PR NEEDS FIXES"
        }
    }
}
