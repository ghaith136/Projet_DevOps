pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    // D√©clench√© par webhook GitHub sur Pull Request vers dev
    triggers {
        githubPush()
    }

    environment {
        APP_NAME = "meteo-app-pr"
        PR_NUMBER = "${env.CHANGE_ID ?: 'manual'}"
        BRANCH_NAME = "${env.CHANGE_BRANCH ?: env.BRANCH_NAME ?: 'unknown'}"
        DOCKER_IMAGE = "meteo-app-pr-${PR_NUMBER}"
        CONTAINER_NAME = "meteo-app-pr-${PR_NUMBER}"
        HOST_PORT = "3001"  # Port d√©di√© pour PR
        DOCKER_PORT = "3000"
    }

    parameters {
        booleanParam(name: 'RUN_TESTS', defaultValue: true, description: 'Ex√©cuter les tests')
        choice(name: 'NODE_VERSION', choices: ['18', '20'], description: 'Version Node.js')
    }

    stages {
        // ===== √âTAPE 1: PR√âPARATION =====
        stage('PR Info') {
            steps {
                script {
                    echo "üîÄ PIPELINE 1: Build & Smoke sur PR"
                    echo "üìå PR #${env.PR_NUMBER}"
                    echo "üåø Branche: ${env.BRANCH_NAME}"
                    echo "üîß Node.js: ${params.NODE_VERSION}"
                    echo "üß™ Tests: ${params.RUN_TESTS ? 'Activ√©s' : 'D√©sactiv√©s'}"
                    
                    // Afficher les changements
                    bat """
                    echo === INFORMATIONS PR ===
                    git log --oneline -5 2>nul || echo "Git non initialis√©"
                    """
                }
            }
        }

        // ===== √âTAPE 2: CHECKOUT PR =====
        stage('Checkout PR') {
            steps {
                echo "üì• R√©cup√©ration du code PR"
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '${sha1}']],
                    extensions: [
                        [$class: 'PreBuildMerge', options: [mergeTarget: 'origin/dev', mergeStrategy: 'DEFAULT', fastForwardMode: 'FF']]
                    ],
                    userRemoteConfigs: [[
                        refspec: '+refs/pull/${CHANGE_ID}/merge:refs/remotes/origin/PR-${CHANGE_ID}',
                        url: 'https://github.com/votre-repo/projet-devops.git'
                    ]]
                ])
                
                bat 'dir'
            }
        }

        // ===== √âTAPE 3: INSTALLATION =====
        stage('Install & Lint') {
            steps {
                parallel(
                    'Install Dependencies': {
                        bat """
                        echo üì¶ Installation des d√©pendances...
                        npm ci
                        echo ‚úÖ D√©pendances install√©es
                        """
                    },
                    'Code Analysis': {
                        script {
                            echo "üîç Analyse du code"
                            bat """
                            echo V√©rification syntaxe...
                            node -c server.js && echo ‚úÖ Syntaxe OK || echo ‚ùå Erreur syntaxe
                            
                            echo V√©rification package.json...
                            npm audit --audit-level=high 2>&1 | tee audit_report.txt || echo Audit termin√©
                            """
                        }
                    }
                )
            }
        }

        // ===== √âTAPE 4: BUILD =====
        stage('Build') {
            steps {
                echo "üèóÔ∏è Construction"
                bat """
                echo Build de l'application...
                npm run build
                echo ‚úÖ Build termin√©
                
                echo === RAPPORT BUILD ===
                echo "PR: ${env.PR_NUMBER}" > pr_build_info.txt
                echo "Branche: ${env.BRANCH_NAME}" >> pr_build_info.txt
                echo "Date: %DATE% %TIME%" >> pr_build_info.txt
                node --version >> pr_build_info.txt
                """
            }
        }

        // ===== √âTAPE 5: TESTS UNITAIRE =====
        stage('Unit Tests') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                echo "üß™ Tests unitaires"
                bat """
                echo Ex√©cution des tests...
                npm test 2>&1 | tee test_results.txt
                
                if errorlevel 1 (
                    echo ‚ùå Tests √©chou√©s
                    exit 1
                )
                echo ‚úÖ Tests r√©ussis
                """
            }
        }

        // ===== √âTAPE 6: DOCKER BUILD =====
        stage('Docker Build') {
            steps {
                echo "üê≥ Construction Docker"
                bat """
                echo Construction image pour PR...
                docker build -t ${env.DOCKER_IMAGE} .
                echo ‚úÖ Image construite: ${env.DOCKER_IMAGE}
                """
            }
        }

        // ===== √âTAPE 7: SMOKE TEST =====
        stage('Smoke Test') {
            steps {
                script {
                    echo "üöÄ Smoke Test"
                    
                    // Nettoyage pr√©alable
                    bat """
                    echo üßπ Nettoyage ancien conteneur...
                    docker stop ${env.CONTAINER_NAME} 2>nul || echo OK
                    docker rm ${env.CONTAINER_NAME} 2>nul || echo OK
                    """
                    
                    // Lancer le conteneur
                    bat """
                    echo D√©marrage conteneur PR...
                    docker run -d -p ${env.HOST_PORT}:${env.DOCKER_PORT} --name ${env.CONTAINER_NAME} ${env.DOCKER_IMAGE}
                    timeout /t 15 /nobreak
                    """
                    
                    // Tests
                    bat """
                    echo üß™ Test smoke...
                    
                    set TEST_PASSED=0
                    
                    for /l %%i in (1,1,3) do (
                        if !TEST_PASSED! equ 0 (
                            echo Tentative %%i/3...
                            
                            powershell -Command "
                            try {
                                \$response = Invoke-WebRequest -Uri 'http://localhost:${env.HOST_PORT}' -UseBasicParsing -TimeoutSec 10
                                if (\$response.StatusCode -eq 200) {
                                    Write-Host '‚úÖ Smoke test r√©ussi'
                                    exit 0
                                } else {
                                    Write-Host '‚ùå Status: ' \$response.StatusCode
                                    exit 1
                                }
                            } catch {
                                Write-Host '‚ùå Erreur: ' \$_.Exception.Message
                                exit 1
                            }
                            "
                            
                            if !errorlevel! equ 0 (
                                set TEST_PASSED=1
                                echo ‚úÖ Test r√©ussi
                            ) else (
                                if %%i lss 3 (
                                    echo ‚è≥ Nouvelle tentative...
                                    timeout /t 5 /nobreak
                                )
                            )
                        )
                    )
                    
                    if !TEST_PASSED! equ 0 (
                        echo ‚ùå Smoke test √©chou√©
                        docker logs ${env.CONTAINER_NAME}
                        exit 1
                    )
                    
                    echo ‚úÖ Smoke test termin√©
                    """
                }
            }
        }

        // ===== √âTAPE 8: RAPPORT PR =====
        stage('PR Report') {
            steps {
                script {
                    echo "üìä G√©n√©ration rapport PR"
                    
                    // Cr√©er un rapport
                    bat """
                    echo "# Rapport PR #${env.PR_NUMBER}" > pr_report.md
                    echo "" >> pr_report.md
                    echo "## R√©sum√©" >> pr_report.md
                    echo "- **PR:** #${env.PR_NUMBER}" >> pr_report.md
                    echo "- **Branche:** ${env.BRANCH_NAME}" >> pr_report.md
                    echo "- **Statut:** ‚úÖ PASSED" >> pr_report.md
                    echo "- **Date:** %DATE% %TIME%" >> pr_report.md
                    echo "" >> pr_report.md
                    echo "## Tests" >> pr_report.md
                    echo "- ‚úÖ Build r√©ussi" >> pr_report.md
                    echo "- ‚úÖ Tests unitaires" >> pr_report.md
                    echo "- ‚úÖ Smoke test" >> pr_report.md
                    echo "- ‚úÖ Docker build" >> pr_report.md
                    echo "" >> pr_report.md
                    echo "## D√©tails" >> pr_report.md
                    echo "\`\`\`" >> pr_report.md
                    docker images ${env.DOCKER_IMAGE} >> pr_report.md
                    echo "\`\`\`" >> pr_report.md
                    """
                    
                    // Archiver
                    archiveArtifacts artifacts: 'pr_report.md, test_results.txt, audit_report.txt, pr_build_info.txt', fingerprint: true
                }
            }
        }

        // ===== √âTAPE 9: NETTOYAGE =====
        stage('Cleanup') {
            steps {
                echo "üßπ Nettoyage"
                bat """
                docker stop ${env.CONTAINER_NAME} 2>nul || echo OK
                docker rm ${env.CONTAINER_NAME} 2>nul || echo OK
                docker rmi ${env.DOCKER_IMAGE} 2>nul || echo OK
                """
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "üßΩ Workspace nettoy√©"
        }
        
        success {
            echo "‚úÖ PR READY FOR MERGE"
            script {
                // Mettre √† jour le statut GitHub
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    bat """
                    echo Mise √† jour statut GitHub...
                    curl -X POST -H "Authorization: token %GITHUB_TOKEN%" \\
                         -H "Accept: application/vnd.github.v3+json" \\
                         https://api.github.com/repos/votre-repo/projet-devops/statuses/${env.GIT_COMMIT} \\
                         -d "{\\"state\\":\\"success\\",\\"description\\":\\"Build PR r√©ussi\\",\\"context\\":\\"jenkins/pr-build\\"}"
                    """
                }
            }
        }
        
        failure {
            echo "‚ùå PR NEEDS FIXES"
            script {
                // Mettre √† jour le statut GitHub
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    bat """
                    echo Mise √† jour statut GitHub...
                    curl -X POST -H "Authorization: token %GITHUB_TOKEN%" \\
                         -H "Accept: application/vnd.github.v3+json" \\
                         https://api.github.com/repos/votre-repo/projet-devops/statuses/${env.GIT_COMMIT} \\
                         -d "{\\"state\\":\\"failure\\",\\"description\\":\\"Build PR √©chou√©\\",\\"context\\":\\"jenkins/pr-build\\"}"
                    """
                }
            }
        }
    }
}
