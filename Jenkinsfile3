pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '20'))
    }

    environment {
        VERSION = "v1.0.0"
        DOCKER_IMAGE = "meteo-app:${VERSION}"
        CONTAINER_NAME = "meteo-${BUILD_NUMBER}"
        HOST_PORT = "3000"  // Port 3000
        ARTIFACT_DIR = "artifacts-${VERSION}"
    }

    stages {
        stage('Version Info') {
            steps {
                echo "PIPELINE 3: Build Versionne"
                echo "Version: ${VERSION}"
                bat "mkdir ${ARTIFACT_DIR}"
            }
        }

        stage('Checkout') {
            steps {
                echo "Checkout code"
                checkout scm
                
                bat """
                echo ${VERSION} > ${ARTIFACT_DIR}/version.txt
                echo Build ${BUILD_NUMBER} >> ${ARTIFACT_DIR}/version.txt
                """
            }
        }

        stage('Build') {
            steps {
                bat """
                npm install
                npm run build
                
                echo Version: ${VERSION} > ${ARTIFACT_DIR}/build_info.txt
                echo Date: %DATE% %TIME% >> ${ARTIFACT_DIR}/build_info.txt
                """
            }
        }

        stage('Docker Versioned Build') {
            steps {
                bat """
                docker build --no-cache -t ${DOCKER_IMAGE} .
                echo Image versionnee construite
                
                docker save -o ${ARTIFACT_DIR}/meteo-${VERSION}.tar ${DOCKER_IMAGE}
                """
            }
        }

        stage('Versioned Tests') {
            steps {
                script {
                    bat """
                    docker stop ${CONTAINER_NAME} 2>nul || echo OK
                    docker rm ${CONTAINER_NAME} 2>nul || echo OK
                    
                    docker run -d -p ${HOST_PORT}:3000 --name ${CONTAINER_NAME} ${DOCKER_IMAGE}
                    timeout /t 10 /nobreak
                    
                    echo Tests Version ${VERSION} > ${ARTIFACT_DIR}/test_results.txt
                    
                    curl -f http://localhost:${HOST_PORT} && (
                        echo / : PASS >> ${ARTIFACT_DIR}/test_results.txt
                    ) || (
                        echo / : FAIL >> ${ARTIFACT_DIR}/test_results.txt
                        exit 1
                    )
                    
                    curl -f http://localhost:${HOST_PORT}/weather && (
                        echo /weather : PASS >> ${ARTIFACT_DIR}/test_results.txt
                    ) || (
                        echo /weather : WARNING >> ${ARTIFACT_DIR}/test_results.txt
                    )
                    
                    curl -f http://localhost:${HOST_PORT}/health && (
                        echo /health : PASS >> ${ARTIFACT_DIR}/test_results.txt
                    ) || (
                        echo /health : FAIL >> ${ARTIFACT_DIR}/test_results.txt
                        exit 1
                    )
                    
                    docker logs ${CONTAINER_NAME} > ${ARTIFACT_DIR}/docker_logs.txt
                    """
                }
            }
        }

        stage('Generate Report') {
            steps {
                bat """
                echo Version ${VERSION} > ${ARTIFACT_DIR}/report.txt
                echo Build: ${BUILD_NUMBER} >> ${ARTIFACT_DIR}/report.txt
                echo Image: ${DOCKER_IMAGE} >> ${ARTIFACT_DIR}/report.txt
                
                echo # Version ${VERSION} > ${ARTIFACT_DIR}/README.md
                echo ## Artefacts >> ${ARTIFACT_DIR}/README.md
                echo - Image Docker: meteo-${VERSION}.tar >> ${ARTIFACT_DIR}/README.md
                echo - Logs: docker_logs.txt >> ${ARTIFACT_DIR}/README.md
                echo - Tests: test_results.txt >> ${ARTIFACT_DIR}/README.md
                """
            }
        }

        stage('Archive All') {
            steps {
                script {
                    archiveArtifacts artifacts: "${ARTIFACT_DIR}/**", fingerprint: true
                    currentBuild.description = "Version: ${VERSION}"
                }
            }
        }
    }

    post {
        always {
            bat """
            docker stop ${CONTAINER_NAME} 2>nul || echo OK
            docker rm ${CONTAINER_NAME} 2>nul || echo OK
            """
            cleanWs()
        }
        
        success {
            echo "VERSION ${VERSION} - SUCCESS"
        }
        
        failure {
            echo "VERSION ${VERSION} - FAILED"
        }
    }
}
